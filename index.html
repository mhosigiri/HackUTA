<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG + Gemini TTS</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #queryInput { width: 80%; padding: 10px; }
        #submitButton { padding: 10px 20px; cursor: pointer; }
        #status { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Mortgage Q&A Assistant (Speech Output)</h1>

    <input type="text" id="queryInput" placeholder="Ask your mortgage question..." autofocus>
    <button id="submitButton" onclick="generateAndPlayAudio()">Get Answer</button>
    
    <div id="status">Ready.</div>
    
    <audio id="audioPlayer" controls hidden></audio>

    <script>
        async function generateAndPlayAudio() {
            const queryInput = document.getElementById('queryInput');
            const statusDiv = document.getElementById('status');
            const audioPlayer = document.getElementById('audioPlayer');
            const submitButton = document.getElementById('submitButton');

            const query = queryInput.value.trim();
            if (!query) {
                statusDiv.textContent = 'Please enter a question.';
                return;
            }

            // Disable button and update status
            submitButton.disabled = true;
            statusDiv.textContent = 'Thinking and generating speech...';

            try {
                const response = await fetch('/ai-tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) {
                    const errorText = await response.json().then(data => data.error)
                                        .catch(() => 'An unknown error occurred.');
                    throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
                }

                // Get the audio file as a Blob
                const audioBlob = await response.blob();
                
                // Create a temporary URL for the blob and set it as the audio source
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;
                audioPlayer.hidden = false;
                
                // Play the audio
                audioPlayer.play();

                statusDiv.textContent = 'Playing answer...';

            } catch (error) {
                console.error('Operation failed:', error);
                statusDiv.textContent = `Error: ${error.message}`;
            } finally {
                submitButton.disabled = false;
            }
        }
    </script>

</body>
</html>